<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usuarios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="estilo.css" />
    <link rel="shortcut icon" href="/Img/Logo.png">
</head>

<body>
    <div class="wrapper">
        <!-- Barra de navegación -->
        <nav id="sidebar">
            <div class="d-flex">
                <button class="toggle-btn" type="button">
                    <i class='bx bxs-grid-alt bx-rotate-90'></i>
                </button>
                <div class="sidebar-logo">
                    <a href="./Inicio.html">Inicio</a>
                </div>
            </div>
            <ul class="sidebar-nav">
                <li class="sidebar-item">
                    <a href="./usuarios.html" class="sidebar-link">
                        <i class='bx bxs-group'></i>
                        <span>Usuarios</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="./bodegas.html" class="sidebar-link">
                        <i class='bx bxs-store-alt'></i>
                        <span>Bodegas</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="./cajas.html" class="sidebar-link">
                        <i class='bx bx-package'></i>
                        <span>Cajas</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="./piezas.html" class="sidebar-link">
                        <i class='bx bx-extension'></i>
                        <span>Piezas</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="./solicitudes.html" class="sidebar-link">
                        <i class='bx bx-user-voice'></i>
                        <span>Solicitudes</span>
                    </a>
                </li>
            </ul>
            <div class="sidebar-footer align-bottom ">
                <a href="./index.html" class="sidebar-link">
                    <i class='bx bx-log-out'></i>
                    <span>Salir</span>
                </a>
            </div>
        </nav>
        <!-- Fin Barra de navegación -->

        <!-- Tabla de Usuarios -->
        <div class="main main-tb-users">
            <div class="d-grid gap-2 d-md-flex justify-content-md-end d-flex">
                <table id="tablaUsuarios" class="table table-responsive container text-center mt-5">
                    <thead class="th-primary">
                        <tr class="flex-row">
                            <th scope="col">Id</th>
                            <th scope="col">Nombre</th>
                            <th scope="col">Usuario</th>
                            <th scope="col">Contraseña</th>
                            <th scope="col">Rol</th>
                            <th colspan="2">Opciones</th>
                            <th scope="col">
                                <button type="button" class="btn btn-success btn-sm botoncre" data-bs-toggle="modal"
                                    data-bs-target="#exampleModal">Crear Usuario</button>
                                <!-- Modal para Crear Usuario -->
                                <div class="modal fade" id="exampleModal" tabindex="-1"
                                    aria-labelledby="exampleModalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="exampleModalLabel">Registro de usuario</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>
                                            <div id="dataModal" class="modal-body">
                                                <form action="http://localhost:3001/usuarios/validar" method="post">
                                                    <div class="input-group mb-3">
                                                        <span class="input-group-text">
                                                            <i class='bx bx-id-card'></i>
                                                        </span>
                                                        <input type="number" name="id" id="id"
                                                            class="form-control form-control-md fs-6"
                                                            placeholder="Cedula" />
                                                    </div>
                                                    <div class="input-group mb-3">
                                                        <span class="input-group-text">
                                                            <i class="bx bx-user"></i>
                                                        </span>
                                                        <input type="text" name="nombre" id="nombre"
                                                            class="form-control form-control-md fs-6"
                                                            placeholder="Nombre" />
                                                    </div>
                                                    <div class="input-group mb-3">
                                                        <span class="input-group-text">
                                                            <i class='bx bxs-user-badge'></i>
                                                        </span>
                                                        <input type="text" name="nombreUsuario" id="nombreUsuario"
                                                            class="form-control form-control-md fs-6"
                                                            placeholder="Usuario" />
                                                    </div>
                                                    <div class="input-group mb-3">
                                                        <span class="input-group-text">
                                                            <i class="bx bx-lock-alt"></i>
                                                        </span>
                                                        <input type="password" name="contrasena" id="contrasena"
                                                            class="form-control form-control-md fs-6"
                                                            placeholder="Contraseña" />
                                                    </div>
                                                    <div class="input-group mb-3">
                                                        <span class="input-group-text">
                                                            <i class="bx bx-lock-alt"></i>
                                                        </span>
                                                        <input type="password" class="form-control form-control-md fs-6"
                                                            placeholder="Repetir contraseña" />
                                                    </div>
                                                    <div class="input-group mb-3">
                                                        <span class="input-group-text">
                                                            <i class='bx bxs-user-detail'></i>
                                                        </span>
                                                        <select name="rol" id="rol" class="form-select form-select-md">
                                                            <option selected>Rol</option>
                                                            <option>Administrador</option>
                                                            <option>Coordinador</option>
                                                            <option>Técnico</option>
                                                        </select>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary"
                                                            data-bs-dismiss="modal">Cerrar</button>
                                                        <button type="submit" name="registrar" id="registrar" value=""
                                                            class="btn btn-primary">Registrar</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <!-- Contenido de la Tabla -->
                    <tbody class="table-group-divider">
                        <!-- Aquí se insertan dinámicamente las filas de usuarios -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    </div>
    <div class="container mt-5">
        <!-- Modal para Mostrar Datos del Usuario -->
        <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="userModalLabel">Detalles del Usuario</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="userModalBody">
                        <!-- Datos cargados dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Fin Tabla de Usuarios -->
    <!-- Scripts para Interacción con el Backend -->
    <script src="app.js"></script>
    <script src="./script.js"> </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            fetch('http://localhost:3003/usuarios/obtener-usuarios') // Llama al controlador para obtener datos de usuarios
                .then(response => response.json())
                .then(data => {
                    const tablaUsuarios = document.getElementById('tablaUsuarios');
                    const tbody = tablaUsuarios.querySelector('tbody');
                    tbody.innerHTML = ''; // Limpiar el contenido existente

                    data.forEach(usuario => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                                <td>${usuario.id}</td>
                                <td>${usuario.nombre}</td>
                                <td>${usuario.nombreUsuario}</td>
                                <td>${usuario.contrasena}</td>
                                <td>${usuario.rol}</td>
                                <td>   

                                    <button class="btn btn-primary btn-sm botonmod" data-bs-toggle="modal" data-bs-target="#userModal" data-userid="${usuario.id} data-userid="1">Editar</button>
                                    <button class="btn btn-primary btn-sm botonmod" data-bs-toggle="modal" data-bs-target="#userModal" data-userid="${usuario.id}">Editar</button>
                                    <button class="btn btn-sm btn-danger botoneliminar" onclick="eliminarUsuario(${usuario.id})">Eliminar</button>
                                </td>
                            `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error al obtener usuarios:', error));
        });

        function eliminarUsuario(id) {
            if (confirm("¿Estás seguro de que deseas eliminar este usuario?")) {
                fetch(`http://localhost:3003/usuarios/eliminar-usuario/${id}`, {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (response.ok) {
                            location.reload(); // Recargar para ver cambios
                        } else {
                            console.error("Error al eliminar usuario");
                        }
                    })
                    .catch(error => console.error("Error al eliminar usuario:", error));
            }
        }

        document.getElementById("userModal").addEventListener("show.bs.modal", function (event) {
            var button = event.relatedTarget; // Botón que activó el modal
            var userId = button.getAttribute("data-userid"); // Obtener el ID del usuario

            fetch(`http://localhost:3003/usuario/${userId}`)
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Error al obtener datos del servidor");
                    }
                    return response.json(); // Parsear respuesta a JSON
                })
                .then((data) => {
                    if (!data) {
                        throw new Error("Error: Datos del usuario están vacíos");
                    }
                    var modalBody = document.getElementById("userModalBody");
                    modalBody.innerHTML = `
                    <form id="formActualizar" action="http://localhost:3003/usuario/${userId}/actualizar" method="post">
                        <div class="input-group mb-3">
                            <span class="input-group-text"><i class='bx bx-id-card'></i></span>
                            <input disabled type="number" name="id" class="form-control form-control-md fs-6" placeholder="Cédula" value="${data.id}" />
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text"><i class="bx bx-user"></i></span>
                            <input type="text" name="nombre" class="form-control form-control-md fs-6" placeholder="Nombre" value="${data.nombre}" />
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text"><i class='bx bxs-user-badge'></i></span>
                            <input type="text" name="nombreUsuario" class="form-control form-control-md fs-6" placeholder="Usuario" value="${data.nombreUsuario}" />
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text"><i class="bx bx-lock-alt"></i></span>
                            <input type="password" name="contrasena" class="form-control form-control-md fs-6" placeholder="Contraseña" />
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text"><i la bx bx-lock-alt"></i></span>
                            <input type="password" class="form-control form-control-md fs-6" placeholder="Repetir contraseña" />
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text"><i la bx bxs-user-detail'></i></span>
                            <select name="rol" class="form-select form-select-md">
                                <option value="Administrador" ${data.rol === 'Administrador' ? 'selected' : ''}>Administrador</option>
                                <option value="Coordinador" ${data.rol === 'Coordinador' ? 'selected' : ''}>Coordinador</option>
                                <option value="Técnico" ${data.rol === 'Técnico' ? 'selected' : ''}>Técnico</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="submit"  id="saveChangesButton" class="btn btn-primary">Guardar cambios</button>
                        </div>
                    </form>
                `;
                })
                .catch(error => console.error("Error al obtener datos del usuario:", error));
        });
        document.getElementById("userModalBody").addEventListener("submit", function (event) {
            event.preventDefault(); // Evitar recarga de la página

            // Obtener valores del formulario
            var form = event.target;
            var userId = form.getAttribute("data-user-id"); // ID del usuario que se va a actualizar
            var id = form.elements["id"].value;
            var nombre = form.elements["nombre"].value;
            var nombreUsuario = form.elements["nombreUsuario"].value;
            var contrasena = form.elements["contrasena"].value;
            var rol = form.elements["rol"].value;

            // Estructura de datos para enviar al servidor
            var data = {
                id: id,
                nombre: nombre,
                nombreUsuario: nombreUsuario,
                contrasena: contrasena, // Solo si es necesario actualizar
                rol: rol
            };

            // Enviar datos al backend mediante fetch
            fetch(`http://localhost:3003/usuario/${userId}/actualizar`, {//Aqui toma el id del usuario para poder actualizar el registro especifico
                method: "PUT",
                headers: {
                    "Content-Type": "application/json" // Indicar que estamos enviando datos en formato JSON
                },
                body: JSON.stringify(data) // Convertir objeto JavaScript a JSON
            })
                .then(response => {
                    if (response.ok) {
                        alert("Usuario actualizado correctamente");
                        // Redirigir a una página específica o recargar la página para mostrar cambios
                        window.location.href = "";
                    } else {
                        alert("Error al actualizar usuario");
                    }
                })
                .catch(error => {
                    console.error("Error al enviar datos al backend:", error);
                });
        });
    </script>


    </div>
</body>

</html>